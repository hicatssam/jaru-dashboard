<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>تفاصيل الطلبات - الجرو | Order Details</title>
<style>
body { font-family:'Cairo',sans-serif; background:#f4f4f9; margin:0; padding:0; color:#333; }
header { background:#FFC501; padding:20px; text-align:center; position:relative; }
header h1 { margin:0; color:#222; font-size:32px; }
header img { height:60px; position:absolute; right:20px; top:15px; }
.lang-toggle { position:absolute; top:20px; left:20px; background:#fff; border:1px solid #ccc; border-radius:6px; padding:5px 10px; cursor:pointer; font-size:14px; }
.container { max-width:1200px; margin:0 auto; padding:20px; }
.card-orders { display:flex; flex-wrap:wrap; gap:20px; margin:30px 0; }
.order-card { background:linear-gradient(135deg,#fff8e1,#ffe082); border-radius:20px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1); flex:1 1 calc(33.333% - 20px); min-width:280px; transition:0.3s; position:relative; }
.order-card:hover { transform:scale(1.02); box-shadow:0 6px 18px rgba(0,0,0,0.15); }
.order-card h3 { margin:0 0 10px; color:#222; }
.order-card p { margin:5px 0; }
.order-card .price { font-weight:bold; color:#e53935; }
.order-card .status, .payment-badge { padding:6px 12px; border-radius:20px; font-size:14px; font-weight:bold; display:inline-block; margin-top:10px; }
.order-card .status { background-color:#90caf9; color:#fff; }
.payment-badge.paid { background-color:#4caf50; color:#fff; }
.payment-badge.unpaid { background-color:#f44336; color:#fff; }
.order-card .new-badge { position:absolute; top:-10px; left:-10px; background:#e53935; color:#fff; font-size:12px; font-weight:bold; padding:6px 12px; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
table { width:100%; border-collapse: collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-top:20px;}
th, td { padding:12px 10px; text-align:center; font-size:14px; word-wrap:break-word; }
th { background:#ffe082; color:#444; }
tr:nth-child(even){background:#f9f9f9;}
select.payment-select { padding:5px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
.payment-badge-table.paid { background:#4caf50; color:#fff; padding:4px 10px; border-radius:12px; font-weight:bold; }
.payment-badge-table.unpaid { background:#f44336; color:#fff; padding:4px 10px; border-radius:12px; font-weight:bold; }
#exportExcelBtn,#deleteAllBtn { background:linear-gradient(135deg,#ff7e5f,#feb47b); color:#fff; border:none; padding:12px 20px; font-size:16px; border-radius:10px; cursor:pointer; margin-bottom:20px; transition:0.2s; }
#exportExcelBtn:hover,#deleteAllBtn:hover{transform:translateY(-3px); box-shadow:0 6px 18px rgba(0,0,0,0.3);}
.delete-btn { background:linear-gradient(135deg,#f44336,#e53935); color:#fff; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; transition:0.2s; }
.delete-btn:hover { transform:scale(1.05); box-shadow:0 4px 12px rgba(0,0,0,0.3);}
footer { background:#333; color:white; text-align:center; padding:15px 0; margin-top:40px; }
/* Alert */
.alert-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:999; visibility:hidden; opacity:0; transition:0.3s; }
.alert-show { visibility:visible; opacity:1; }
.alert-box { background:#fff; padding:30px 20px; border-radius:20px; text-align:center; max-width:400px; width:90%; box-shadow:0 15px 35px rgba(0,0,0,0.3); transform: scale(0.5); transition: transform 0.3s ease, opacity 0.3s ease; opacity:0;}
.alert-show .alert-box { transform:scale(1); opacity:1;}
.alert-box h3 { margin:15px 0 0; font-size:22px; color:#222;}
.alert-box button { margin:10px; min-width:100px; padding:12px 20px; border-radius:12px; font-weight:bold; cursor:pointer; transition:0.2s; border:none; }
.alert-box button:hover { transform:scale(1.05);}
@media (max-width:992px){.order-card{flex:1 1 calc(50% - 20px);}}
@media (max-width:600px){.order-card{flex:1 1 100%;} header h1{font-size:24px;} th, td{font-size:12px;padding:8px;} #exportExcelBtn,#deleteAllBtn{font-size:14px; padding:10px 15px;}}
</style>
</head>
<body>

<header>
<img src="images/logo.svg.jpg" alt="Al Jarou Logo">
<h1 id="page-title">تفاصيل الطلبات - الجرو | Order Details</h1>
<button class="lang-toggle" onclick="toggleLang()">English</button>
</header>

<div class="container">
<h2 id="latest-title">أحدث 3 طلبات | Latest 3 Orders</h2>
<div class="card-orders" id="latest-orders"></div>

<h2 id="all-title">جميع الطلبات | All Orders</h2>
<button id="exportExcelBtn">تصدير Excel</button>
<button id="deleteAllBtn">حذف كل الطلبات</button>

<table>
<thead>
<tr>
<th id="th-customer">الزبون | Customer</th>
<th id="th-orders">الطلبات | Orders</th>
<th id="th-total">المبلغ | Total</th>
<th id="th-date">التاريخ | Date</th>
<th id="th-payment">طريقة الدفع | Payment</th>
<th id="th-payment-status">حالة الدفع | Payment Status</th>
<th id="th-status">الحالة | Status</th>
<th>إجراءات | Actions</th>
</tr>
</thead>
<tbody id="table-orders"></tbody>
</table>
</div>

<footer>
<p id="footer-text">&copy; 2025 Al Jarou. جميع الحقوق محفوظة. | All rights reserved.</p>
</footer>

<!-- Alert -->
<div id="alertOverlay" class="alert-overlay">
  <div class="alert-box">
    <div style="font-size:50px; color:#f44336;">⚠️</div>
    <h3 id="alertText">هل أنت متأكد؟</h3>
    <div style="margin-top:20px;">
      <button id="confirmBtn"></button>
      <button id="cancelBtn"></button>
    </div>
  </div>
</div>

<!-- صوت تأكيد -->
<audio id="orderSound" src="sounds/confirm.mp3" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// Firebase
const firebaseConfig={
apiKey:"AIzaSyCEsjPeY7773MQeSyiL6M1n4RHRl5TGAyk",
authDomain:"jaru-drinks.firebaseapp.com",
projectId:"jaru-drinks",
storageBucket:"jaru-drinks.appspot.com",
messagingSenderId:"317969024088",
appId:"1:317969024088:web:d99f66953f06572779f62d"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

let orders=[];
let currentLang='ar';
let lastOrderIds=[]; // للتأكد من الطلبات الجديدة فقط

const translations={
  ar:{pageTitle:"تفاصيل الطلبات - الجرو", latest:"أحدث 3 طلبات", all:"جميع الطلبات", customer:"الزبون", orders:"الطلبات", total:"المبلغ", date:"التاريخ", payment:"طريقة الدفع", paymentStatus:"حالة الدفع", status:"الحالة", confirmed:"مؤكد", canceled:"ملغي", paid:"مدفوع", unpaid:"غير مدفوع", footer:"&copy; 2025 Al Jarou. جميع الحقوق محفوظة.", button:"English", alertText:"هل أنت متأكد؟", alertYes:"نعم", alertCancel:"إلغاء", deleteAll:"حذف كل الطلبات", deleteSingle:"حذف"}, 
  en:{pageTitle:"Order Details - Al Jarou", latest:"Latest 3 Orders", all:"All Orders", customer:"Customer", orders:"Orders", total:"Total", date:"Date", payment:"Payment Method", paymentStatus:"Payment Status", status:"Status", confirmed:"Confirmed", canceled:"Canceled", paid:"Paid", unpaid:"Unpaid", footer:"&copy; 2025 Al Jarou. All rights reserved.", button:"العربية", alertText:"Are you sure?", alertYes:"Yes", alertCancel:"Cancel", deleteAll:"Delete All Orders", deleteSingle:"Delete"}
};

// عناصر Alert
const alertOverlay=document.getElementById("alertOverlay");
const alertText=document.getElementById("alertText");
const confirmBtn=document.getElementById("confirmBtn");
const cancelBtn=document.getElementById("cancelBtn");
let alertCallback=null;

// تفعيل اللغة
function toggleLang(){
  currentLang=currentLang==='ar'?'en':'ar';
  const t=translations[currentLang];
  document.getElementById('page-title').innerHTML=t.pageTitle;
  document.getElementById('latest-title').textContent=t.latest;
  document.getElementById('all-title').textContent=t.all;
  document.getElementById('th-customer').textContent=t.customer;
  document.getElementById('th-orders').textContent=t.orders;
  document.getElementById('th-total').textContent=t.total;
  document.getElementById('th-date').textContent=t.date;
  document.getElementById('th-payment').textContent=t.payment;
  document.getElementById('th-payment-status').textContent=t.paymentStatus;
  document.getElementById('th-status').textContent=t.status;
  document.getElementById('footer-text').innerHTML=t.footer;
  document.querySelector('.lang-toggle').textContent=t.button;
  confirmBtn.textContent=t.alertYes;
  cancelBtn.textContent=t.alertCancel;
  renderOrders();
}

// عرض الطلبات
function renderOrders(){
  const latestContainer=document.getElementById("latest-orders");
  const tableBody=document.getElementById("table-orders");
  latestContainer.innerHTML="";
  tableBody.innerHTML="";
  if(!orders.length) return;

  const sortedOrders=orders.sort((a,b)=>Date.parse(`${b.date} ${b.time}`)-Date.parse(`${a.date} ${a.time}`));

  // البطاقات
  const latestOrders=sortedOrders.slice(0,3);
  latestOrders.forEach((order,index)=>{
    const drinks=order.drinksOrder.map(d=>{
      const sugar=['Coffee','Tea'].includes(d.drinkName)?(d.sugarChoice?'(مع سكر)':'(بدون سكر)'):'';
      return `${d.drinkName} ×${d.quantity} ${sugar}`;
    }).join('، ');
    const div=document.createElement("div");
    div.className="order-card";
    div.innerHTML=`<div class="new-badge">New</div>
      <h3>${translations[currentLang].latest} #${index+1}</h3>
      <p><strong>${order.name}</strong></p>
      <p><strong>${translations[currentLang].orders}</strong>: ${drinks}</p>
      <p>${translations[currentLang].payment}: <strong>${order.paymentMethod||'Cash'}</strong></p>
      <p>${translations[currentLang].paymentStatus}: <span class="payment-badge ${order.paymentStatus}">${translations[currentLang][order.paymentStatus]}</span></p>
      <p class="price">${translations[currentLang].total}: ${order.total} ₪</p>
      <p>${translations[currentLang].date}: ${order.date} ${order.time}</p>
      <span class="status ${order.status}">${translations[currentLang][order.status]}</span>`;
    latestContainer.appendChild(div);
  });

  // الجدول
  sortedOrders.forEach((order,index)=>{
    const drinks=order.drinksOrder.map(d=>{
      const sugar=['Coffee','Tea'].includes(d.drinkName)?(d.sugarChoice?'(مع سكر)':'(بدون سكر)'):'';
      return `${d.drinkName} ×${d.quantity} ${sugar}`;
    }).join('، ');

    const row=document.createElement("tr");
    row.innerHTML=`<td><strong>#${index+1}</strong> - ${order.name}</td>
      <td>${drinks}</td>
      <td>${order.total} ₪</td>
      <td>${order.date} ${order.time}</td>
      <td>${order.paymentMethod||'Cash'}</td>
      <td>
        <span class="payment-badge-table ${order.paymentStatus}">${translations[currentLang][order.paymentStatus]}</span>
        <select class="payment-select" onchange="updatePaymentStatus('${order.id}',this.value,this)">
          <option value="paid" ${order.paymentStatus==='paid'?'selected':''}>${translations[currentLang].paid}</option>
          <option value="unpaid" ${order.paymentStatus==='unpaid'?'selected':''}>${translations[currentLang].unpaid}</option>
        </select>
      </td>
      <td><span class="status ${order.status}">${translations[currentLang][order.status]}</span></td>
      <td><button class="delete-btn" onclick="confirmDelete(()=>deleteOrder('${order.id}'))">${translations[currentLang].deleteSingle}</button></td>`;
    tableBody.appendChild(row);
  });
}

// تحديث حالة الدفع
function updatePaymentStatus(orderId,status,selectElement){
  db.collection("orders").doc(orderId).update({paymentStatus:status})
  .then(()=>{
    const tableBadge=selectElement.closest('td')?.querySelector('.payment-badge-table');
    if(tableBadge) tableBadge.className=`payment-badge-table ${status}`, tableBadge.textContent=translations[currentLang][status];
  }).catch(err=>console.error("Error updating payment status:",err));
}

// حذف طلب
function deleteOrder(orderId){
  db.collection("orders").doc(orderId).delete().catch(err=>console.error(err));
}

// حذف كل الطلبات
document.getElementById("deleteAllBtn").addEventListener("click",()=>{
  confirmDelete(()=>{
    orders.forEach(o=>db.collection("orders").doc(o.id).delete());
  });
});

// Alert
function confirmDelete(callback){
  alertCallback = callback;
  alertText.textContent = translations[currentLang].alertText;
  alertOverlay.classList.add("alert-show");
}
confirmBtn.addEventListener("click", ()=>{
  if(alertCallback) alertCallback();
  alertOverlay.classList.remove("alert-show");
  alertCallback = null;
});
cancelBtn.addEventListener("click", ()=>{
  alertOverlay.classList.remove("alert-show");
  alertCallback = null;
});

// جلب البيانات من Firebase + تشغيل صوت للطلبات الجديدة
const orderSound=document.getElementById("orderSound");

db.collection("orders").onSnapshot(snapshot=>{
  const newOrders = snapshot.docs.map(doc=>{
    const data = doc.data();
    return {
      id: doc.id,
      name: data.customerName,
      drinksOrder: data.drinksOrder,
      total: data.totalPrice,
      date: data.date,
      time: data.time,
      paymentMethod: data.paymentMethod || 'Cash',
      paymentStatus: data.paymentStatus || 'unpaid',
      status: data.status || 'confirmed'
    };
  });

  const newIds = newOrders.map(o=>o.id);
  const addedOrders = newIds.filter(id=>!lastOrderIds.includes(id));

  if(addedOrders.length > 0 && lastOrderIds.length > 0){
    orderSound.currentTime=0;
    orderSound.play().catch(err=>console.log("Autoplay blocked:",err));
  }

  orders=newOrders;
  lastOrderIds=newIds;
  renderOrders();
});

// تصدير Excel
document.getElementById('exportExcelBtn').addEventListener('click', ()=>{
  const table = document.querySelector('table');
  if(!table) return alert("الجدول غير موجود!");
  const clone = table.cloneNode(true);
  clone.querySelectorAll('select, button').forEach(el=>el.remove());
  const wb = XLSX.utils.table_to_book(clone,{sheet:"Orders"});
  XLSX.writeFile(wb,'Orders.xlsx');
});
</script>

</body>
</html>
