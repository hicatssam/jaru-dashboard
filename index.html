<!-- أضف زر تصدير Excel -->
<button id="exportExcelBtn" style="margin-bottom:20px; padding:10px 15px; background-color:#007bff; color:white; border:none; border-radius:8px; cursor:pointer;">تصدير إلى Excel</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
function renderOrders() {
    const latestContainer = document.getElementById("latest-orders");
    const tableBody = document.getElementById("table-orders");
    latestContainer.innerHTML = "";
    tableBody.innerHTML = "";

    // عرض أحدث 3 طلبات
    const latestOrders = orders.slice(0,3);
    const otherOrders = orders.slice(3);

    latestOrders.forEach((order,index)=>{
        const div = document.createElement("div");
        div.className="order-card";
        div.innerHTML=`
            <h3>طلب رقم #${index+1}</h3>
            <p><strong>${order.name}</strong></p>
            <p><strong>الطلبات:</strong> ${order.items}</p>
            <p>طريقة الدفع: <strong>${order.paymentMethod || 'Cash'}</strong></p>
            <p class="price">المبلغ: ${order.total} ₪</p>
            <p>التاريخ: ${order.date}</p>
            <span class="status ${order.status}">${order.status}</span>
        `;
        latestContainer.appendChild(div);
    });

    otherOrders.forEach((order,index)=>{
        const row=document.createElement("tr");
        row.innerHTML=`
            <td><strong>#${index+4}</strong> - ${order.name}</td>
            <td>${order.items}</td>
            <td>${order.total} ₪</td>
            <td>${order.date}</td>
            <td>${order.paymentMethod || 'Cash'}</td>
            <td><span class="status ${order.status}">${order.status}</span></td>
        `;
        tableBody.appendChild(row);
    });
}

// زر تصدير Excel
document.getElementById('exportExcelBtn').addEventListener('click', ()=>{
    const table = document.querySelector('table');
    const wb = XLSX.utils.table_to_book(table, {sheet:"Orders"});
    XLSX.writeFile(wb, 'Orders.xlsx');
});

// الاستماع للتغيرات المباشرة في Firebase
db.collection("orders")
  .orderBy("date","desc")
  .onSnapshot(snapshot=>{
      const newOrders = snapshot.docs.map(doc=>{
          const data = doc.data();
          return {
              id: doc.id,
              name: data.customerName,
              items: data.drinksOrder.map(drink=>`${drink.drinkName} ×${drink.quantity} ${drink.sugarChoice===false ? '(بدون سكر)' : '(مع سكر)'} - ${drink.price} ₪`).join('، '),
              total: data.totalPrice,
              date: `${data.date} ${data.time}`,
              paymentMethod: data.paymentMethod || 'Cash',
              status: data.status || "مؤكد"
          }
      });
      if(orders.length && newOrders[0].id !== orders[0].id){
          playNotification();
      }
      orders = newOrders;
      renderOrders();
  });
</script>
