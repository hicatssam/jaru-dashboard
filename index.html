<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>تفاصيل الطلبات - الجرو | Order Details</title>
<style>
body { font-family: 'Cairo', sans-serif; background-color: #f4f4f9; margin:0; padding:0; color:#333; }
header { background-color: #FFC501; padding: 20px; text-align: center; position: relative; }
header h1 { margin:0; color:#222; font-size:32px; }
header img { height:60px; position:absolute; right:20px; top:15px; }
.lang-toggle { position:absolute; top:20px; left:20px; background:#fff; border:1px solid #ccc; border-radius:6px; padding:5px 10px; cursor:pointer; font-size:14px; }

.container { max-width:1200px; margin:0 auto; padding:20px; }
.card-orders { display:flex; flex-wrap:wrap; gap:20px; margin:30px 0; }
.order-card { background: linear-gradient(135deg, #fff8e1, #ffe082); border-radius:20px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1); flex:1 1 calc(33.333% - 20px); min-width:280px; transition:0.3s ease; position: relative; }
.order-card:hover { transform: scale(1.02); box-shadow:0 6px 18px rgba(0,0,0,0.15); }
.order-card h3 {margin:0 0 10px; color:#222;}
.order-card p {margin:5px 0;}
.order-card .price {font-weight:bold; color:#e53935;}
.order-card .status {padding:6px 12px; border-radius:20px; font-size:14px; font-weight:bold; display:inline-block; margin-top:10px;}
.order-card .new-badge {
  position: absolute;
  top: -10px;
  left: -10px;
  background-color: #e53935;
  color: #fff;
  font-size: 12px;
  font-weight: bold;
  padding: 6px 12px;
  border-radius: 50%;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

table { width:100%; border-collapse: collapse; background-color:#fff; border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
th, td { padding:12px 10px; text-align:center; font-size:14px; word-wrap:break-word; }
th { background-color:#ffe082; color:#444; }
tr:nth-child(even) {background-color:#f9f9f9;}

#exportExcelBtn { background: linear-gradient(135deg, #ff7e5f, #feb47b); color: #fff; border: none; padding: 12px 20px; font-size: 16px; border-radius: 10px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-bottom: 20px; }
#exportExcelBtn:hover { transform: translateY(-3px); box-shadow:0 6px 18px rgba(0,0,0,0.3); }

footer { background-color:#333; color:white; text-align:center; padding:15px 0; margin-top:40px; }

@media (max-width: 992px) { .order-card { flex:1 1 calc(50% - 20px); } }
@media (max-width: 600px) { .order-card { flex:1 1 100%; } header h1 { font-size:24px; } th, td { font-size:12px; padding:8px; } #exportExcelBtn { font-size:14px; padding:10px 15px; } }
</style>
</head>
<body>

<header>
<img src="images/logo.svg.jpg" alt="Al Jarou Logo">
<h1 id="page-title">تفاصيل الطلبات - الجرو | Order Details</h1>
<button class="lang-toggle" onclick="toggleLang()">English</button>
</header>

<button id="enableSoundBtn">تفعيل صوت الإشعارات</button>
<audio id="notificationSound" src="sounds/confirm.mp3" preload="auto"></audio>

<div class="container">
<h2 id="latest-title">أحدث 3 طلبات | Latest 3 Orders</h2>
<div class="card-orders" id="latest-orders"></div>

<h2 id="all-title">جميع الطلبات | All Orders</h2>
<button id="exportExcelBtn">تصدير Excel</button>

<table>
<thead>
<tr>
<th id="th-customer">الزبون | Customer</th>
<th id="th-orders">الطلبات | Orders</th>
<th id="th-total">المبلغ | Total</th>
<th id="th-date">التاريخ | Date</th>
<th id="th-payment">طريقة الدفع | Payment</th>
<th id="th-status">الحالة | Status</th>
</tr>
</thead>
<tbody id="table-orders"></tbody>
</table>
</div>

<footer>
<p id="footer-text">&copy; 2025 Al Jarou. جميع الحقوق محفوظة. | All rights reserved.</p>
</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCEsjPeY7773MQeSyiL6M1n4RHRl5TGAyk",
  authDomain: "jaru-drinks.firebaseapp.com",
  projectId: "jaru-drinks",
  storageBucket: "jaru-drinks.appspot.com",
  messagingSenderId: "317969024088",
  appId: "1:317969024088:web:d99f66953f06572779f62d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let orders = [];
const notificationSound = document.getElementById("notificationSound");
let soundEnabled = false;

const translations = {
  ar: {pageTitle:"تفاصيل الطلبات - الجرو", latest:"أحدث 3 طلبات", all:"جميع الطلبات", customer:"الزبون", orders:"الطلبات", total:"المبلغ", date:"التاريخ", payment:"طريقة الدفع", status:"الحالة", confirmed:"مؤكد", canceled:"ملغي", footer:"&copy; 2025 Al Jarou. جميع الحقوق محفوظة.", button:"English"},
  en: {pageTitle:"Order Details - Al Jarou", latest:"Latest 3 Orders", all:"All Orders", customer:"Customer", orders:"Orders", total:"Total", date:"Date", payment:"Payment Method", status:"Status", confirmed:"Confirmed", canceled:"Canceled", footer:"&copy; 2025 Al Jarou. All rights reserved.", button:"العربية"}
};

let currentLang = 'ar';

function toggleLang() {
  currentLang = currentLang==='ar'?'en':'ar';
  const t = translations[currentLang];
  document.getElementById('page-title').innerHTML = t.pageTitle;
  document.getElementById('latest-title').textContent = t.latest;
  document.getElementById('all-title').textContent = t.all;
  document.getElementById('th-customer').textContent = t.customer;
  document.getElementById('th-orders').textContent = t.orders;
  document.getElementById('th-total').textContent = t.total;
  document.getElementById('th-date').textContent = t.date;
  document.getElementById('th-payment').textContent = t.payment;
  document.getElementById('th-status').textContent = t.status;
  document.getElementById('footer-text').innerHTML = t.footer;
  document.querySelector('.lang-toggle').textContent = t.button;
  renderOrders();
}

// تفعيل الصوت
document.getElementById("enableSoundBtn").addEventListener("click", () => {
  soundEnabled = true;
  notificationSound.play().then(()=>notificationSound.pause());
  document.getElementById("enableSoundBtn").style.display="none";
});

function renderOrders() {
  const latestContainer = document.getElementById("latest-orders");
  const tableBody = document.getElementById("table-orders");
  latestContainer.innerHTML = "";
  tableBody.innerHTML = "";

  if(!orders.length) return;

  const sortedOrders = orders.sort((a,b)=>Date.parse(`${b.date} ${b.time}`)-Date.parse(`${a.date} ${a.time}`));

  // عرض أحدث 3 طلبات
  const latestOrders = sortedOrders.slice(0,3);
  latestOrders.forEach((order,index)=>{
    const div = document.createElement("div");
    div.className = "order-card";

    const drinks = order.drinksOrder.map(d=>{
      // فقط المشروبات لها خيار السكر
      const isBeverage = ['Coffee','Tea'].includes(d.drinkName);
      const sugar = isBeverage ? (d.sugarChoice ? '(مع سكر)' : '(بدون سكر)') : '';
      return `${d.drinkName} ×${d.quantity} ${sugar}`;
    }).join('، ');

    div.innerHTML = `
      <div class="new-badge">New</div>
      <h3>${translations[currentLang].latest} #${index+1}</h3>
      <p><strong>${order.name}</strong></p>
      <p><strong>${translations[currentLang].orders}</strong>: ${drinks}</p>
      <p>${translations[currentLang].payment}: <strong>${order.paymentMethod || 'Cash'}</strong></p>
      <p class="price">${translations[currentLang].total}: ${order.total} ₪</p>
      <p>${translations[currentLang].date}: ${order.date} ${order.time}</p>
      <span class="status ${order.status}">${translations[currentLang][order.status]}</span>
    `;
    latestContainer.appendChild(div);
  });

  // عرض كل الطلبات في الجدول
  sortedOrders.forEach((order,index)=>{
    const row = document.createElement("tr");
    const drinks = order.drinksOrder.map(d=>{
      const isBeverage = ['Coffee','Tea'].includes(d.drinkName);
      const sugar = isBeverage ? (d.sugarChoice ? '(مع سكر)' : '(بدون سكر)') : '';
      return `${d.drinkName} ×${d.quantity} ${sugar}`;
    }).join('، ');

    row.innerHTML = `
      <td><strong>#${index+1}</strong> - ${order.name}</td>
      <td>${drinks}</td>
      <td>${order.total} ₪</td>
      <td>${order.date} ${order.time}</td>
      <td>${order.paymentMethod || 'Cash'}</td>
      <td><span class="status ${order.status}">${translations[currentLang][order.status]}</span></td>
    `;
    tableBody.appendChild(row);
  });
}

// جلب البيانات من Firebase وتشغيل الصوت عند وجود طلب جديد
db.collection("orders").onSnapshot(snapshot=>{
  const newOrders = snapshot.docs.map(doc=>{
    const data = doc.data();
    return {
      id: doc.id,
      name: data.customerName,
      drinksOrder: data.drinksOrder,
      total: data.totalPrice,
      date: data.date,
      time: data.time,
      paymentMethod: data.paymentMethod || 'Cash',
      status: data.status || 'confirmed'
    };
  });

  if(soundEnabled && orders.length){
    newOrders.forEach(order=>{
      if(!orders.find(o=>o.id===order.id)){
        notificationSound.play().catch(e=>console.log("Error playing sound:",e));
      }
    });
  }

  orders = newOrders;
  renderOrders();
});

// تصدير Excel
document.getElementById('exportExcelBtn').addEventListener('click', ()=>{
  const table = document.querySelector('table');
  if(!table) return alert("الجدول غير موجود!");
  const wb = XLSX.utils.table_to_book(table,{sheet:"Orders"});
  XLSX.writeFile(wb,'Orders.xlsx');
});
</script>

</body>
</html>
